name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  implement:
    # Run if:
    # 1. Issue opened from Meeting Actions app, OR
    # 2. allow-deps label added to a Meeting Actions issue, OR
    # 3. Someone comments /retry on a Meeting Actions issue
    if: |
      contains(github.event.issue.body, 'Created from Meeting Actions') && (
        github.event.action == 'opened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'allow-deps') ||
        (github.event.action == 'created' && contains(github.event.comment.body, '/retry'))
      )
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @anthropic-ai/bedrock-sdk

      - name: Run auto-implement script
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
        run: node scripts/auto-implement.js

      - name: Commit and push changes
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Debug: Show what files changed
          echo "=== Git status before reset ==="
          git status --short

          # Reset package files that may have been modified by npm install
          git checkout -- package.json package-lock.json 2>/dev/null || true

          # Remove status file from staging
          rm -f auto-implement-status.json

          # Debug: Show what files changed after reset
          echo "=== Git status after reset ==="
          git status --short

          # Debug: Show diff of changed files
          echo "=== Git diff ==="
          git diff --stat

          # Add source files - use individual commands to avoid one failure stopping others
          echo "Adding pages/"
          git add pages/ && echo "  Added pages/" || echo "  Failed to add pages/"
          echo "Adding lib/"
          git add lib/ && echo "  Added lib/" || echo "  Failed to add lib/"
          echo "Adding components/"
          git add components/ 2>/dev/null && echo "  Added components/" || echo "  No components/ directory"
          echo "Adding styles/"
          git add styles/ 2>/dev/null && echo "  Added styles/" || echo "  No styles/ directory"
          echo "Adding scripts/"
          git add scripts/ && echo "  Added scripts/" || echo "  Failed to add scripts/"

          # Fallback: explicitly add any modified tracked files
          echo "=== Adding any remaining modified files ==="
          git add -u
          git status --short

          # Debug: Show staged changes
          echo "=== Staged changes ==="
          git diff --staged --stat

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-implement: ${ISSUE_TITLE} (closes #${ISSUE_NUMBER})"
            git push
          fi

      - name: Check implementation status
        id: status
        if: always()
        run: |
          if [ -f auto-implement-status.json ]; then
            echo "status_exists=true" >> $GITHUB_OUTPUT
            echo "needs_deps=$(jq -r '.needsDepsLabel // false' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "needs_clarification=$(jq -r '.needsClarification // false' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "clarification_needed=$(jq -r '.clarificationNeeded // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "summary=$(jq -r '.summary // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "analysis=$(jq -r '.analysis // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
          else
            echo "status_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment - needs clarification
        if: steps.status.outputs.needs_clarification == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const clarification = process.env.CLARIFICATION_NEEDED || 'More details needed';
            const analysis = process.env.ANALYSIS || 'Unable to determine';
            const body = [
              'ü§î I need more information to implement this correctly.',
              '',
              'What I understood: ' + analysis,
              '',
              'What I need to know: ' + clarification,
              '',
              'Please update the issue description with more details, or reply to this comment with the information needed. Then comment `/retry` to try again.'
            ].join('\n');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            })
        env:
          CLARIFICATION_NEEDED: ${{ steps.status.outputs.clarification_needed }}
          ANALYSIS: ${{ steps.status.outputs.analysis }}

      - name: Comment - needs dependencies label
        if: steps.status.outputs.needs_deps == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è **This change requires adding new dependencies.**

            To proceed:
            1. Add the \`allow-deps\` label to this issue
            2. Re-run the workflow by closing and reopening this issue, or comment \`/retry\`

            _The auto-implement bot will not add packages without explicit permission._`
            })

      - name: Comment on success
        if: success() && steps.status.outputs.needs_deps != 'true' && steps.status.outputs.needs_clarification != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Changes have been automatically implemented and pushed to main. Vercel will deploy shortly.'
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå Auto-implementation failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

      - name: Push notification - code pushed
        if: success() && steps.status.outputs.needs_deps != 'true' && steps.status.outputs.needs_clarification != 'true'
        run: |
          curl -s \
            -H "Title: Auto-implement done" \
            -H "Tags: white_check_mark" \
            -d "Done: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Waiting for Vercel deploy..." \
            ntfy.sh/${{ secrets.NTFY_TOPIC }}
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      - name: Wait for Vercel deployment
        if: success() && steps.status.outputs.needs_deps != 'true' && steps.status.outputs.needs_clarification != 'true'
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "Waiting for Vercel deployment of ${COMMIT_SHA}..."

          for i in $(seq 1 60); do
            sleep 10
            # Get deployment statuses for this commit
            STATUS=$(curl -s \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/commits/${COMMIT_SHA}/status" \
              | jq -r '.statuses[] | select(.context | test("vercel|Vercel"; "i")) | .state' \
              | head -1)

            if [ "$STATUS" = "success" ]; then
              echo "Vercel deployment succeeded!"
              curl -s \
                -H "Title: Vercel deploy complete" \
                -H "Tags: rocket" \
                -d "Deployed: ${ISSUE_TITLE} (#${ISSUE_NUMBER}) is now live!" \
                ntfy.sh/${{ secrets.NTFY_TOPIC }}
              exit 0
            elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
              echo "Vercel deployment failed!"
              curl -s \
                -H "Title: Vercel deploy failed" \
                -H "Tags: x" \
                -H "Priority: high" \
                -d "Deploy failed: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Check Vercel dashboard." \
                ntfy.sh/${{ secrets.NTFY_TOPIC }}
              exit 0
            fi

            echo "Attempt ${i}/60 - status: ${STATUS:-pending}..."
          done

          echo "Timed out waiting for deployment"
          curl -s \
            -H "Title: Vercel deploy status unknown" \
            -H "Tags: warning" \
            -d "Timed out waiting for deploy: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Check Vercel dashboard." \
            ntfy.sh/${{ secrets.NTFY_TOPIC }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      - name: Push notification - failure
        if: failure()
        run: |
          curl -s \
            -H "Title: Auto-implement failed" \
            -H "Tags: x" \
            -H "Priority: high" \
            -d "Failed: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Check GitHub Actions for details." \
            ntfy.sh/${{ secrets.NTFY_TOPIC }}
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
