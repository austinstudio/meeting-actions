name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  implement:
    # Run if:
    # 1. Issue opened from Meeting Actions app, OR
    # 2. allow-deps label added to a Meeting Actions issue, OR
    # 3. Someone comments /retry on a Meeting Actions issue
    if: |
      contains(github.event.issue.body, 'Created from Meeting Actions') && (
        github.event.action == 'opened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'allow-deps') ||
        (github.event.action == 'created' && contains(github.event.comment.body, '/retry'))
      )
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @anthropic-ai/bedrock-sdk

      - name: Run auto-implement script
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
        run: node scripts/auto-implement.js

      - name: Commit and push changes
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Debug: Show what files changed
          echo "=== Git status before reset ==="
          git status --short

          # Reset package files that may have been modified by npm install
          git checkout -- package.json package-lock.json 2>/dev/null || true

          # Remove status file from staging
          rm -f auto-implement-status.json

          # Debug: Show what files changed after reset
          echo "=== Git status after reset ==="
          git status --short

          # Debug: Show diff of changed files
          echo "=== Git diff ==="
          git diff --stat

          # Add source files - use individual commands to avoid one failure stopping others
          echo "Adding pages/"
          git add pages/ && echo "  Added pages/" || echo "  Failed to add pages/"
          echo "Adding lib/"
          git add lib/ && echo "  Added lib/" || echo "  Failed to add lib/"
          echo "Adding components/"
          git add components/ 2>/dev/null && echo "  Added components/" || echo "  No components/ directory"
          echo "Adding styles/"
          git add styles/ 2>/dev/null && echo "  Added styles/" || echo "  No styles/ directory"
          echo "Adding scripts/"
          git add scripts/ && echo "  Added scripts/" || echo "  Failed to add scripts/"

          # Fallback: explicitly add any modified tracked files
          echo "=== Adding any remaining modified files ==="
          git add -u
          git status --short

          # Debug: Show staged changes
          echo "=== Staged changes ==="
          git diff --staged --stat

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-implement: ${ISSUE_TITLE} (closes #${ISSUE_NUMBER})"
            git push
          fi

      - name: Check implementation status
        id: status
        if: always()
        run: |
          if [ -f auto-implement-status.json ]; then
            echo "status_exists=true" >> $GITHUB_OUTPUT
            echo "needs_deps=$(jq -r '.needsDepsLabel // false' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "needs_clarification=$(jq -r '.needsClarification // false' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "clarification_needed=$(jq -r '.clarificationNeeded // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "summary=$(jq -r '.summary // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "analysis=$(jq -r '.analysis // ""' auto-implement-status.json)" >> $GITHUB_OUTPUT
          else
            echo "status_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment - needs clarification
        if: steps.status.outputs.needs_clarification == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const clarification = process.env.CLARIFICATION_NEEDED || 'More details needed';
            const analysis = process.env.ANALYSIS || 'Unable to determine';
            const body = [
              'ü§î I need more information to implement this correctly.',
              '',
              'What I understood: ' + analysis,
              '',
              'What I need to know: ' + clarification,
              '',
              'Please update the issue description with more details, or reply to this comment with the information needed. Then comment `/retry` to try again.'
            ].join('\n');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            })
        env:
          CLARIFICATION_NEEDED: ${{ steps.status.outputs.clarification_needed }}
          ANALYSIS: ${{ steps.status.outputs.analysis }}

      - name: Comment - needs dependencies label
        if: steps.status.outputs.needs_deps == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è **This change requires adding new dependencies.**

            To proceed:
            1. Add the \`allow-deps\` label to this issue
            2. Re-run the workflow by closing and reopening this issue, or comment \`/retry\`

            _The auto-implement bot will not add packages without explicit permission._`
            })

      - name: Comment on success
        if: success() && steps.status.outputs.needs_deps != 'true' && steps.status.outputs.needs_clarification != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Changes have been automatically implemented and pushed to main. Vercel will deploy shortly.'
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå Auto-implementation failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

      - name: SMS notification - success
        if: success() && steps.status.outputs.needs_deps != 'true' && steps.status.outputs.needs_clarification != 'true'
        run: |
          curl -s -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_SID}/Messages.json" \
            -u "${TWILIO_SID}:${TWILIO_AUTH_TOKEN}" \
            --data-urlencode "From=${TWILIO_FROM}" \
            --data-urlencode "To=${TWILIO_TO}" \
            --data-urlencode "Body=‚úÖ Auto-implement done: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Vercel will deploy shortly."
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM_NUMBER }}
          TWILIO_TO: ${{ secrets.TWILIO_TO_NUMBER }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      - name: SMS notification - failure
        if: failure()
        run: |
          curl -s -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_SID}/Messages.json" \
            -u "${TWILIO_SID}:${TWILIO_AUTH_TOKEN}" \
            --data-urlencode "From=${TWILIO_FROM}" \
            --data-urlencode "To=${TWILIO_TO}" \
            --data-urlencode "Body=‚ùå Auto-implement FAILED: ${ISSUE_TITLE} (#${ISSUE_NUMBER}). Check GitHub Actions for details."
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM_NUMBER }}
          TWILIO_TO: ${{ secrets.TWILIO_TO_NUMBER }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
