name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  implement:
    # Run if:
    # 1. Issue opened from Meeting Actions app, OR
    # 2. allow-deps label added to a Meeting Actions issue, OR
    # 3. Someone comments /retry on a Meeting Actions issue
    if: |
      contains(github.event.issue.body, 'Created from Meeting Actions') && (
        github.event.action == 'opened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'allow-deps') ||
        (github.event.action == 'created' && contains(github.event.comment.body, '/retry'))
      )
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @anthropic-ai/bedrock-sdk

      - name: Run auto-implement script
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
        run: node scripts/auto-implement.js

      - name: Commit and push changes
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-implement: ${ISSUE_TITLE} (closes #${ISSUE_NUMBER})"
            git push
          fi

      - name: Check implementation status
        id: status
        if: always()
        run: |
          if [ -f auto-implement-status.json ]; then
            echo "status_exists=true" >> $GITHUB_OUTPUT
            echo "needs_deps=$(jq -r '.needsDepsLabel' auto-implement-status.json)" >> $GITHUB_OUTPUT
            echo "summary=$(jq -r '.summary' auto-implement-status.json)" >> $GITHUB_OUTPUT
          else
            echo "status_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment - needs dependencies label
        if: steps.status.outputs.needs_deps == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ **This change requires adding new dependencies.**

            To proceed:
            1. Add the \`allow-deps\` label to this issue
            2. Re-run the workflow by closing and reopening this issue, or comment \`/retry\`

            _The auto-implement bot will not add packages without explicit permission._`
            })

      - name: Comment on success
        if: success() && steps.status.outputs.needs_deps != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ Changes have been automatically implemented and pushed to main. Vercel will deploy shortly.'
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '❌ Auto-implementation failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
